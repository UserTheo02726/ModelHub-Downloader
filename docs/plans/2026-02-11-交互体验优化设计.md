# ModelHub Downloader - 交互体验优化设计

**版本**: 1.1  
**日期**: 2026-02-11  
**状态**: 待实现

> **更新说明 (v1.1)**: 基于 HuggingFace Hub 官方文档和 Rich Progress 文档更新了设计，使用精确异常检测替代字符串匹配，使用 `redirect_stdout/stderr` 参数抑制详细日志。

---

## 1. 背景与目标

### 1.1 当前问题

1. **认证错误处理不佳**：用户下载 gated model 或遇到 rate limiting 时，只显示技术性错误信息，用户不知道如何解决
2. **进度条混乱**：HuggingFace 和 ModelScope 的下载各自显示详细进度，用户无法获得清晰的总体进度
3. **用户体验中断**：遇到认证问题后，用户需要手动返回主菜单再重试

### 1.2 优化目标

| 目标 | 描述 |
|------|------|
| 友好认证错误 | 检测认证问题，显示友好提示，让用户选择下一步操作 |
| 统一进度条 | 单进度条显示，隐藏底层库细节输出 |
| 流畅交互 | 认证失败后用户可选择查看指南、返回主菜单或重试 |

---

## 2. 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    DownloadSession                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    下载流程                                 │  │
│  │                                                             │  │
│  │  run_download_setup()  →  execute_download()               │  │
│  │         ↓                     ↓                            │  │
│  │  配置输入              UnifiedProgressBar (总进度)          │  │
│  │         ↓                     ↓                            │  │
│  │  选择源                 HF/MS 下载器                        │  │
│  │         ↓                     ↓                            │  │
│  │  验证模型 ←──── 认证检查 ──→ 下载完成                       │  │
│  │         ↓                                                   │  │
│  │  [认证失败?] → show_auth_error() → 询问用户                │  │
│  │         ↓                                                   │  │
│  │  返回主菜单 或 显示认证指南                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. AuthChecker 组件

### 3.1 职责

在下载前预检查模型是否需要认证，避免下载中途失败。

### 3.2 设计

```python
from huggingface_hub import HfApi
from huggingface_hub.errors import GatedRepoError
from httpx import HTTPStatusError
from typing import Tuple


class AuthChecker:
    """
    认证状态检查器
    
    在下载前检查模型是否需要认证
    使用 HuggingFace 官方异常类型进行精确检测，而非字符串匹配
    """
    
    def check_model_access(self, model_id: str, source: str) -> Tuple[bool, str]:
        """
        检查模型访问权限
        
        Args:
            model_id: 模型 ID
            source: 下载源 (hf/ms)
            
        Returns:
            Tuple[需要认证, 错误信息]
        """
        # 对于 HF，先尝试快速探测
        if source == "hf":
            try:
                # 轻量级 API 调用（不获取文件列表）
                info = HfApi().model_info(
                    model_id, 
                    files_metadata=False,
                    timeout=10  # 10秒超时
                )
                return False, ""
            except GatedRepoError as e:
                # 精确捕获 gated model 错误
                # GatedRepoError 包含完整的错误信息和解决方案链接
                return True, str(e)
            except HTTPStatusError as e:
                # 401 Unauthorized - 可能需要认证或 rate limiting
                if e.response.status_code == 401:
                    return True, f"401 Unauthorized: 可能需要认证或已达到下载限速"
                # 其他 HTTP 错误不视为认证问题
                return False, ""
            except Exception as e:
                # 网络错误、超时等不视为认证问题
                return False, ""
        
        # MS 不需要认证检查（根据当前需求）
        return False, ""
```

### 3.3 关键设计点

| 设计决策 | 理由 |
|---------|------|
| 使用 `model_info` 而非 `snapshot_download` | 轻量级探测，只需一次 API 调用 |
| 使用 `GatedRepoError` 异常类型 | 基于官方文档的精确异常检测，替代字符串匹配 |
| 使用 `HTTPStatusError` 检测 401 | 区分认证问题和普通网络错误 |
| 10 秒超时 | 平衡探测速度和用户体验 |

### 3.4 异常处理说明

根据 HuggingFace Hub 官方文档 (`huggingface_hub.errors` 模块):

```python
from huggingface_hub.errors import (
    GatedRepoError,      # Gated Model 访问被拒绝
    RepositoryNotFoundError,  # 模型不存在
    HTTPStatusError,     # HTTP 错误 (401, 403, 404, etc.)
)
```

**参考来源**: 
- GitHub Issue #2586: https://github.com/huggingface/huggingface_hub/issues/2586
- Stack Overflow: https://stackoverflow.com/questions/79211723/

---

## 4. UnifiedProgressBar 组件

### 4.1 职责

提供统一的进度条界面，隐藏 HuggingFace 和 ModelScope 底层库的详细进度输出。

### 4.2 设计

```python
from contextlib import contextmanager
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn
from rich.console import Console


class UnifiedProgressBar:
    """
    统一进度条组件
    
    特性：
    - 单进度条显示，隐藏底层库的详细输出
    - 使用 redirect_stdout/stderr 抑制详细日志
    - 下载完成后自动隐藏 (transient=True)
    """
    
    def __init__(self):
        self._console = Console()
        self._progress = Progress(
            SpinnerColumn(style="cyan"),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(complete_style="green", finished_style="green"),
            TaskProgressColumn(),
            TextColumn("[dim]{task.completed}/{task.total}[/dim]"),
            transient=True,           # 完成后自动隐藏
            redirect_stdout=True,     # 重定向标准输出
            redirect_stderr=True,    # 重定向标准错误
            console=self._console,
        )
    
    @contextmanager
    def HF(self, model_id: str):
        """HF 下载上下文"""
        task_id = self._progress.add_task(
            f"Downloading [cyan]{model_id}[/cyan] from HuggingFace...",
            total=100,
        )
        self._progress.start()
        try:
            yield
        finally:
            self._progress.update(task_id, completed=100)
            self._progress.stop()
    
    @contextmanager
    def MS(self, model_id: str):
        """MS 下载上下文"""
        task_id = self._progress.add_task(
            f"Downloading [cyan]{model_id}[/cyan] from ModelScope...",
            total=100,
        )
        self._progress.start()
        try:
            yield
        finally:
            self._progress.update(task_id, completed=100)
            self._progress.stop()
```

### 4.3 Rich Progress 关键参数说明

根据 Rich 官方文档 (`rich.readthedocs.io`):

| 参数 | 作用 | 设计中的应用 |
|------|------|-------------|
| `transient=True` | 进度条在完成/退出后自动隐藏 | ✅ 用于下载完成后自动消失 |
| `redirect_stdout=True` | 重定向标准输出，隐藏底层库的 print | ✅ 抑制 HuggingFace 的详细进度日志 |
| `redirect_stderr=True` | 重定向标准错误 | ✅ 抑制底层库的错误输出（只保留我们的错误处理） |

**优点**: 使用官方提供的参数而非自己抑制日志，代码更简洁，行为更可预测。

### 4.4 进度条界面示例

```
Downloading facebook/sam3 from HuggingFace...   0% [00:00<?, ?it/s]
```

---

## 5. 认证错误处理

### 5.1 show_auth_error 函数

```python
from rich.prompt import Prompt
from rich.panel import Panel


def show_auth_error(model_id: str, source: str, error_msg: str = "") -> str:
    """
    显示认证错误信息并询问用户操作
    
    Args:
        model_id: 模型 ID
        source: 下载源
        error_msg: GatedRepoError 原始错误信息（已包含解决方案）
        
    Returns:
        str: 用户选择的操作
        - "guide": 查看认证指南
        - "back": 返回主菜单
        - "retry": 重试下载
    """
    error_panel = Panel.fit(
        f"[bold red]认证错误[/bold red]\n\n"
        f"模型 [cyan]{model_id}[/cyan] 需要认证才能下载。\n\n"
        f"[yellow]详细信息:[/yellow]\n"
        f"  {error_msg}\n\n"
        f"[yellow]快速解决:[/yellow]\n"
        f"  1. 访问 https://huggingface.co/{model_id}\n"
        f"  2. 登录账户并接受使用协议\n"
        f"  3. 设置 HF_TOKEN 环境变量",
        title="认证失败",
        border_style="red",
    )
    rprint(error_panel)
    
    return Prompt.ask(
        "\n[yellow]请选择操作:[/yellow]\n"
        "  [1] 查看认证指南\n"
        "  [2] 返回主菜单\n"
        "  [3] 重试下载",
        choices=["1", "2", "3"],
        default="2",
    )
```

### 5.2 show_auth_guide 函数

```python
def show_auth_guide():
    """显示详细认证指南"""
    guide = Panel.fit(
        "[bold]HuggingFace 认证指南[/bold]\n\n"
        "[yellow]方法 1: 使用 HF_TOKEN 环境变量 (推荐)[/yellow]\n"
        "  1. 访问 https://huggingface.co/settings/tokens\n"
        "  2. 点击 [green]New token[/green]\n"
        "  3. 输入名称，选择 [green]read[/green] 权限\n"
        "  4. 复制 token\n\n"
        "  PowerShell:\n"
        "    [cyan]$env:HF_TOKEN = \"your_token_here\"[/cyan]\n\n"
        "  CMD:\n"
        "    [cyan]set HF_TOKEN=your_token_here[/cyan]\n\n"
        "[yellow]方法 2: 使用 huggingface-cli[/yellow]\n"
        "  1. 安装 CLI: [cyan]pip install huggingface-cli[/cyan]\n"
        "  2. 登录: [cyan]huggingface-cli login[/cyan]\n"
        "  3. 输入 token 完成认证\n\n"
        "[yellow]注意事项[/yellow]\n"
        "  - Token 需要 [green]read[/green] 或 [green]repo[/green] 权限\n"
        "  - 设置后需要重启当前终端才能生效\n"
        "  - 推荐使用环境变量而非 CLI 登录（更稳定）",
        title="认证指南",
        border_style="cyan",
    )
    rprint(guide)
```

---

## 6. 交互流程整合

### 6.1 修改后的 DownloadSession

```python
class DownloadSession:
    def __init__(self):
        self.config = DownloadConfig()
        self.download_history: list[str] = []
        self.auth_checker = AuthChecker()
        self.progress_bar = UnifiedProgressBar()
    
    def execute_download(self) -> bool:
        """
        执行下载
        
        Returns:
            bool: True 下载成功，False 下载失败或用户取消
        """
        model_id = self.config.model_id
        source = self.config.source
        
        # 1. 认证检查（只对 HF）
        if source in ("hf", "auto"):
            need_auth, error_msg = self.auth_checker.check_model_access(model_id, "hf")
            if need_auth:
                action = show_auth_error(model_id, source, error_msg)
                
                if action == "1":
                    show_auth_guide()
                    return False
                elif action == "2":
                    return False
                # action == "3" 则继续重试
        
        # 2. 执行下载（使用统一进度条）
        try:
            if source == "hf":
                with self.progress_bar.HF(model_id):
                    success = self._download_hf(model_id)
            elif source == "ms":
                with self.progress_bar.MS(model_id):
                    success = self._download_ms(model_id)
            else:  # auto
                need_auth, _ = self.auth_checker.check_model_access(model_id, "hf")
                if not need_auth:
                    with self.progress_bar.HF(model_id):
                        success = self._download_hf(model_id)
                else:
                    rprint("[yellow]自动切换到 ModelScope...[/yellow]")
                    with self.progress_bar.MS(model_id):
                        success = self._download_ms(model_id)
            
            if success:
                self.add_to_history(model_id)
                return True
            return False
            
        except Exception as e:
            rprint(f"\n[red]下载失败: {e}[/red]")
            return False
    
    def _download_hf(self, model_id: str) -> bool:
        """HF 下载"""
        d = ModelDownloader(
            output_dir=self.config.output_dir or DEFAULT_OUTPUT,
            source="hf",
        )
        return d.download(model_id)
    
    def _download_ms(self, model_id: str) -> bool:
        """MS 下载"""
        d = ModelDownloader(
            output_dir=self.config.output_dir or DEFAULT_OUTPUT,
            source="ms",
        )
        return d.download(model_id)
```

### 6.2 用户交互流程图

```
用户选择开始下载
        ↓
认证检查 (AuthChecker)
        ↓
    ┌─── 需要认证? ────┐
    ↓                ↓
   是               否
    ↓                ↓
show_auth_error()   执行下载
    ↓                ↓
┌──┴──┐          UnifiedProgressBar
↓     ↓               ↓
查看   返回        下载完成
指南   主菜单          ↓
    ↓              添加到历史
返回主菜单            ↓
                   返回 True
```

---

## 7. 文件变更汇总

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `main.py` | 新增 | `AuthChecker` 类（使用 `GatedRepoError`） |
| `main.py` | 新增 | `UnifiedProgressBar` 类（使用 `redirect_stdout/stderr`） |
| `main.py` | 新增 | `show_auth_error()` 函数 |
| `main.py` | 新增 | `show_auth_guide()` 函数 |
| `main.py` | 修改 | `DownloadSession.execute_download()` |
| `tests/test_auth_checker.py` | 新增 | AuthChecker 单元测试 |
| `tests/test_unified_progress.py` | 新增 | UnifiedProgressBar 单元测试 |

---

## 8. 测试计划

### 8.1 AuthChecker 测试

| 测试场景 | 输入 | 预期输出 |
|---------|------|---------|
| 公开模型 | 公开模型 ID | `False, ""` |
| Gated Model | gated 模型 ID | `True, <GatedRepoError 消息>` |
| Rate Limit | 触发限速 | `True, "401 Unauthorized..."` |
| MS 模型 | MS 模型 ID | `False, ""` |
| 网络错误 | 超时/连接失败 | `False, ""` (不视为认证问题) |

### 8.2 UnifiedProgressBar 测试

| 测试场景 | 预期行为 |
|---------|---------|
| HF 下载 | 显示 HF 进度条，隐藏详细日志 |
| MS 下载 | 显示 MS 进度条，隐藏详细日志 |
| 下载完成 | 进度条自动消失 |
| 下载失败 | 进度条更新为完成状态 |

### 8.3 集成测试

| 测试场景 | 预期行为 |
|---------|---------|
| 公开模型下载 | 正常下载，显示统一进度条 |
| Gated Model | 显示认证错误，询问用户操作 |
| 用户选择查看指南 | 显示认证指南面板 |
| 用户选择返回主菜单 | 返回主菜单 |
| 用户选择重试 | 重新执行认证检查 |

---

## 9. 与原设计 (v1.0) 的差异

| 改进点 | 原设计 (v1.0) | 新设计 (v1.1) |
|--------|--------------|---------------|
| 认证错误检测 | 字符串匹配 `any(t in error_msg for t in ...)` | 精确异常 `isinstance(e, GatedRepoError)` |
| 日志抑制 | 手动设置 logger level | 使用 Rich Progress `redirect_stdout/stderr` |
| 错误信息 | 自行构造错误信息 | 直接使用 HuggingFace 返回的完整信息 |
| 错误类型覆盖 | 只检测 "401", "Unauthorized" | 使用 `HTTPStatusError` 检测所有 HTTP 错误 |

---

## 10. 后续工作

- [ ] 实现 AuthChecker 组件（使用 `GatedRepoError`）
- [ ] 实现 UnifiedProgressBar 组件（使用 `redirect_stdout/stderr`）
- [ ] 实现 `show_auth_error()` 和 `show_auth_guide()`
- [ ] 修改 `DownloadSession.execute_download()` 集成新组件
- [ ] 编写单元测试
- [ ] 集成测试验证
- [ ] 代码审查和优化

---

## 11. 附录

### 11.1 参考资料

**HuggingFace Hub 官方文档**:
- 认证错误处理: https://github.com/huggingface/huggingface_hub/issues/2586
- 错误异常类型: `huggingface_hub.errors.GatedRepoError`

**Rich Progress 官方文档**:
- Transient Progress: https://rich.readthedocs.io/en/latest/progress.html#transient-progress
- Progress Reference: https://rich.readthedocs.io/en/latest/reference/progress.html

### 11.2 参考实现

- `.ref/download_models.py` - 参考的下载脚本
- 当前 `main.py` - 现有实现
